# Vulnerability Scanning API Reference

Complete API reference for Perseus vulnerability scanning endpoints and integration patterns.

## Base URL

All API endpoints are relative to your Perseus instance:
```
https://perseus.example.com:8000
```

## Authentication

Include your API key in the Authorization header:
```bash
curl -H "Authorization: Bearer your-api-key" \
  http://localhost:8000/api/endpoint
```

## Core Analysis Endpoints

### Source Code Analysis with Vulnerabilities

**Endpoint:** `POST /analyze/source`

Analyze source code and automatically include vulnerability scanning.

```bash
curl -X POST http://localhost:8000/analyze/source \
  -H "Content-Type: application/json" \
  -d '{
    "type": "source",
    "language": "java",
    "location": "/app/data/my-project",
    "options": {
      "include_vulnerabilities": true,
      "deep_scan": true
    }
  }'
```

**Response:**
```json
{
  "analysis_id": "abc123-def456-789",
  "status": "started",
  "message": "Source code analysis initiated"
}
```

### Get Analysis Results with Vulnerabilities

**Endpoint:** `GET /analyze/{analysis_id}/results`

Retrieve complete analysis results including vulnerability data.

```bash
curl http://localhost:8000/analyze/abc123-def456-789/results
```

**Response:**
```json
{
  "analysis_id": "abc123-def456-789",
  "status": "completed",
  "components": [
    {
      "name": "log4j-core",
      "version": "2.14.0",
      "type": "java-archive",
      "purl": "pkg:maven/org.apache.logging.log4j/log4j-core@2.14.0",
      "vulnerability_count": 4,
      "critical_vulnerabilities": 2,
      "metadata": {
        "syft_type": "java-archive",
        "locations": ["/pom.xml"]
      }
    }
  ],
  "vulnerability_summary": {
    "critical": 5,
    "high": 12,
    "medium": 8,
    "low": 3,
    "total": 28
  }
}
```

## Vulnerability-Specific Endpoints

### Get Vulnerability Scan Results

**Endpoint:** `GET /vulnerabilities/scan/{analysis_id}`

Get detailed vulnerability information for an analysis.

```bash
curl http://localhost:8000/vulnerabilities/scan/abc123-def456-789
```

**Response:**
```json
{
  "analysis_id": "abc123-def456-789",
  "summary": {
    "critical": 5,
    "high": 12,
    "medium": 8,
    "low": 3
  },
  "vulnerable_components": [
    {
      "component_name": "log4j-core",
      "component_version": "2.14.0",
      "purl": "pkg:maven/org.apache.logging.log4j/log4j-core@2.14.0",
      "vulnerability_count": 4,
      "critical_vulnerabilities": 2,
      "vulnerabilities": [
        {
          "id": "GHSA-jfh8-c2jp-5v3q",
          "severity": "critical",
          "cvss_score": 10.0,
          "description": "Apache Log4j2 JNDI features do not protect against attacker controlled LDAP and other JNDI related endpoints.",
          "fixed_in": "2.15.0"
        }
      ]
    }
  ],
  "scan_metadata": {
    "scan_performed": true,
    "scan_date": "2025-07-20T12:55:20.411935",
    "total_components": 25
  }
}
```

### Scan Individual Component

**Endpoint:** `POST /vulnerabilities/scan/component`

Scan a single component for vulnerabilities.

```bash
curl -X POST http://localhost:8000/vulnerabilities/scan/component \
  -H "Content-Type: application/json" \
  -d '{
    "name": "spring-web",
    "version": "4.3.17.RELEASE",
    "type": "java"
  }'
```

**Using PURL:**
```bash
curl -X POST http://localhost:8000/vulnerabilities/scan/component \
  -H "Content-Type: application/json" \
  -d '{
    "purl": "pkg:maven/org.springframework/spring-web@4.3.17.RELEASE"
  }'
```

**Response:**
```json
{
  "component": {
    "name": "spring-web",
    "version": "4.3.17.RELEASE",
    "purl": "pkg:maven/org.springframework/spring-web@4.3.17.RELEASE"
  },
  "vulnerabilities": [
    {
      "id": "CVE-2018-1270",
      "severity": "critical",
      "cvss_score": 9.8,
      "description": "Spring Framework allows applications to configure Spring MVC to serve static resources.",
      "fixed_in": "4.3.18.RELEASE"
    }
  ],
  "scan_metadata": {
    "scan_date": "2025-07-20T13:05:15.123456",
    "scanner": "grype",
    "vulnerability_count": 7
  }
}
```

### Bulk Component Scanning

**Endpoint:** `POST /vulnerabilities/scan/bulk`

Scan multiple components in a single request.

```bash
curl -X POST http://localhost:8000/vulnerabilities/scan/bulk \
  -H "Content-Type: application/json" \
  -d '{
    "components": [
      {
        "name": "log4j-core",
        "version": "2.14.0",
        "type": "java"
      },
      {
        "purl": "pkg:maven/commons-collections/commons-collections@3.2.1"
      },
      {
        "name": "jackson-databind",
        "version": "2.9.8",
        "type": "java"
      }
    ]
  }'
```

**Response:**
```json
{
  "scan_id": "bulk-scan-789",
  "results": [
    {
      "component": {
        "name": "log4j-core",
        "version": "2.14.0"
      },
      "vulnerability_count": 4,
      "critical_vulnerabilities": 2
    },
    {
      "component": {
        "purl": "pkg:maven/commons-collections/commons-collections@3.2.1"
      },
      "vulnerability_count": 2,
      "critical_vulnerabilities": 1
    }
  ],
  "summary": {
    "total_components": 3,
    "vulnerable_components": 3,
    "total_vulnerabilities": 59,
    "critical": 15,
    "high": 22,
    "medium": 18,
    "low": 4
  }
}
```

## CI/CD Integration Endpoints

### Register CI/CD Build

**Endpoint:** `POST /api/v1/cicd/builds`

Register a new build for CI/CD vulnerability scanning.

```bash
curl -X POST http://localhost:8000/api/v1/cicd/builds \
  -H "Content-Type: application/json" \
  -d '{
    "build_id": "jenkins-456",
    "project": {
      "name": "my-microservice",
      "path": "/app/data/my-microservice",
      "type": "java",
      "branch": "main",
      "commit": "abc123def456",
      "version": "1.2.3"
    },
    "ci_context": {
      "platform": "jenkins",
      "build_id": "jenkins-456",
      "job_name": "security-scan",
      "workspace": "/app/data/my-microservice",
      "timestamp": "2025-07-20T13:00:00Z"
    }
  }'
```

**Response:**
```json
{
  "build_id": "jenkins-456",
  "status": "registered"
}
```

### Start CI/CD Vulnerability Scan

**Endpoint:** `POST /api/v1/cicd/builds/{build_id}/scan`

Start vulnerability scanning for a registered build.

**Synchronous Scan:**
```bash
curl -X POST http://localhost:8000/api/v1/cicd/builds/jenkins-456/scan \
  -H "Content-Type: application/json" \
  -d '{
    "scan_type": "full",
    "wait": true,
    "timeout": 300,
    "policies": [],
    "output_formats": ["spdx", "cyclonedx"]
  }'
```

**Asynchronous Scan:**
```bash
curl -X POST http://localhost:8000/api/v1/cicd/builds/jenkins-456/scan \
  -H "Content-Type: application/json" \
  -d '{
    "scan_type": "full",
    "wait": false
  }'
```

**Response (Synchronous):**
```json
{
  "build_id": "jenkins-456",
  "analysis_id": "analysis-789",
  "status": "completed",
  "vulnerabilities": {
    "critical": 2,
    "high": 5,
    "medium": 8,
    "low": 3
  }
}
```

**Response (Asynchronous):**
```json
{
  "build_id": "jenkins-456",
  "analysis_id": "analysis-789",
  "status": "scanning",
  "message": "Scan started in background"
}
```

### Get CI/CD Build Status

**Endpoint:** `GET /api/v1/cicd/builds/{build_id}/status`

Check the status of a CI/CD build scan.

```bash
curl http://localhost:8000/api/v1/cicd/builds/jenkins-456/status
```

**Response:**
```json
{
  "build_id": "jenkins-456",
  "status": "completed",
  "progress": 100,
  "analysis_id": "analysis-789",
  "error": null,
  "started_at": "2025-07-20T13:05:00Z",
  "completed_at": "2025-07-20T13:07:45Z"
}
```

**Status Values:**
- `registered`: Build registered, not started
- `scanning`: SBOM generation in progress
- `analyzing`: Vulnerability analysis in progress
- `completed`: Scan completed successfully
- `failed`: Scan failed with errors

### Get CI/CD Build Results

**Endpoint:** `GET /api/v1/cicd/builds/{build_id}/results`

Get detailed vulnerability scan results for a CI/CD build.

```bash
curl http://localhost:8000/api/v1/cicd/builds/jenkins-456/results
```

**Response:**
```json
{
  "build_id": "jenkins-456",
  "status": "completed",
  "component_count": 45,
  "vulnerabilities": {
    "critical": 2,
    "high": 8,
    "medium": 12,
    "low": 5
  },
  "licenses": ["Apache-2.0", "MIT", "BSD-3-Clause"],
  "sbom_formats": ["spdx", "cyclonedx"],
  "scan_duration_seconds": 165.3,
  "ci_context": {
    "platform": "jenkins",
    "build_id": "jenkins-456",
    "job_name": "security-scan"
  },
  "vulnerable_components": [
    {
      "name": "log4j-core",
      "version": "2.14.0",
      "vulnerability_count": 4,
      "critical_vulnerabilities": 2
    }
  ]
}
```

### Get Build Artifacts

**Endpoint:** `GET /api/v1/cicd/builds/{build_id}/artifacts`

Get generated SBOMs and reports for a build.

```bash
curl http://localhost:8000/api/v1/cicd/builds/jenkins-456/artifacts
```

**Response:**
```json
{
  "build_id": "jenkins-456",
  "artifacts": [
    {
      "type": "sbom",
      "format": "spdx",
      "filename": "sbom-spdx-analysis-789.json",
      "size_bytes": 15672,
      "download_url": "/api/v1/cicd/builds/jenkins-456/artifacts/sbom-spdx-analysis-789.json"
    },
    {
      "type": "sbom",
      "format": "cyclonedx",
      "filename": "sbom-cyclonedx-analysis-789.json",
      "size_bytes": 18543,
      "download_url": "/api/v1/cicd/builds/jenkins-456/artifacts/sbom-cyclonedx-analysis-789.json"
    },
    {
      "type": "report",
      "format": "json",
      "filename": "vulnerability-report-analysis-789.json",
      "size_bytes": 12456,
      "download_url": "/api/v1/cicd/builds/jenkins-456/artifacts/vulnerability-report-analysis-789.json"
    }
  ]
}
```

## Database Management Endpoints

### Check Vulnerability Database Status

**Endpoint:** `GET /vulnerabilities/database/status`

Check the status of the vulnerability database.

```bash
curl http://localhost:8000/vulnerabilities/database/status
```

**Response:**
```json
{
  "scanner": "grype",
  "available": true,
  "database_info": {
    "status": "available",
    "details": "Schema: v6.0.2, Built: 2025-07-20T04:24:59Z",
    "database_path": "/app/data/grype-db"
  },
  "offline_capable": true,
  "last_updated": "2025-07-20T04:24:59Z",
  "update_available": false
}
```

### Update Vulnerability Database

**Endpoint:** `POST /vulnerabilities/database/update`

Trigger an update of the vulnerability database.

```bash
curl -X POST http://localhost:8000/vulnerabilities/database/update
```

**Response:**
```json
{
  "status": "update_started",
  "message": "Database update initiated",
  "update_id": "update-123"
}
```

### Get Vulnerability Summary

**Endpoint:** `GET /vulnerabilities/summary`

Get platform-wide vulnerability statistics.

```bash
curl http://localhost:8000/vulnerabilities/summary
```

**Response:**
```json
{
  "total_analyses": 156,
  "total_components": 8945,
  "total_vulnerabilities": 2341,
  "severity_breakdown": {
    "critical": 45,
    "high": 234,
    "medium": 1567,
    "low": 495
  },
  "most_vulnerable_components": [
    {
      "name": "log4j-core",
      "version": "2.14.0",
      "vulnerability_count": 4,
      "occurrences": 23
    }
  ],
  "database_info": {
    "last_updated": "2025-07-20T04:24:59Z",
    "total_cves": 245678
  }
}
```

## Error Handling

All endpoints return standard HTTP status codes and JSON error responses.

### Common Error Responses

**400 Bad Request:**
```json
{
  "detail": "Invalid request format",
  "error_code": "INVALID_REQUEST",
  "message": "Missing required field: project.path"
}
```

**404 Not Found:**
```json
{
  "detail": "Analysis not found",
  "error_code": "ANALYSIS_NOT_FOUND",
  "analysis_id": "invalid-id"
}
```

**429 Too Many Requests:**
```json
{
  "detail": "Rate limit exceeded",
  "error_code": "RATE_LIMIT_EXCEEDED",
  "retry_after": 60
}
```

**500 Internal Server Error:**
```json
{
  "detail": "Vulnerability scan failed",
  "error_code": "SCAN_FAILED",
  "message": "Grype database unavailable"
}
```

## Rate Limiting

API endpoints are subject to rate limiting:

- **Analysis endpoints**: 10 requests per minute
- **Component scanning**: 100 requests per minute  
- **Status/results**: 60 requests per minute
- **Database operations**: 5 requests per minute

Rate limit headers are included in responses:
```
X-RateLimit-Limit: 10
X-RateLimit-Remaining: 7
X-RateLimit-Reset: 1642692000
```

## Authentication & Authorization

### API Key Authentication

Include your API key in the Authorization header:
```bash
curl -H "Authorization: Bearer your-api-key-here" \
  http://localhost:8000/api/endpoint
```

### JWT Authentication (Enterprise)

For enterprise deployments with JWT:
```bash
curl -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  http://localhost:8000/api/endpoint
```

### Permissions

Different operations require different permission levels:

- **Read access**: View analysis results, component information
- **Scan access**: Perform vulnerability scans, SBOM generation
- **Admin access**: Database updates, system configuration

## Integration Examples

### Complete CI/CD Workflow

```bash
#!/bin/bash
# Complete CI/CD vulnerability scanning workflow

BUILD_ID="ci-build-$(date +%s)"
PROJECT_PATH="/app/data/my-project"

# 1. Register build
echo "Registering build..."
curl -X POST http://localhost:8000/api/v1/cicd/builds \
  -H "Content-Type: application/json" \
  -d "{
    \"build_id\": \"$BUILD_ID\",
    \"project\": {
      \"name\": \"my-project\",
      \"path\": \"$PROJECT_PATH\",
      \"type\": \"java\"
    },
    \"ci_context\": {
      \"platform\": \"jenkins\",
      \"build_id\": \"$BUILD_ID\"
    }
  }"

# 2. Start scan
echo "Starting vulnerability scan..."
SCAN_RESPONSE=$(curl -X POST http://localhost:8000/api/v1/cicd/builds/$BUILD_ID/scan \
  -H "Content-Type: application/json" \
  -d '{"scan_type": "full", "wait": true}')

# 3. Parse results
CRITICAL=$(echo "$SCAN_RESPONSE" | jq -r '.vulnerabilities.critical')
HIGH=$(echo "$SCAN_RESPONSE" | jq -r '.vulnerabilities.high')

# 4. Apply security gate
if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 5 ]; then
  echo "Security gate failed: Critical=$CRITICAL, High=$HIGH"
  exit 1
fi

echo "Security scan passed"
```

### Monitoring Integration

```bash
# Get vulnerability metrics for monitoring
curl http://localhost:8000/vulnerabilities/summary | \
  jq '.severity_breakdown | to_entries[] | "\(.key): \(.value)"'

# Check database health
curl http://localhost:8000/vulnerabilities/database/status | \
  jq -r '.available'
```

## Best Practices

1. **Cache Results**: Store scan results to avoid repeated scans
2. **Batch Requests**: Use bulk endpoints for multiple components
3. **Monitor Limits**: Respect rate limits and implement backoff
4. **Error Handling**: Implement proper error handling and retries
5. **Security**: Use HTTPS and secure API key storage
6. **Timeouts**: Set appropriate timeouts for long-running scans